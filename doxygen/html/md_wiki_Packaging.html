<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>parallel-preprocessor: Packaging and Release</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">parallel-preprocessor
   &#160;<span id="projectnumber">0.3.0.f176d79</span>
   </div>
   <div id="projectbrief">MPI distributive and multithreading massively parallel geometry processor     for large scale CAE and machine learning, by Qingfeng Xia, UKAEA, 2019</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_wiki_Packaging.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Packaging and Release </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Package generation by CPack</h1>
<h2>Introduction to CPack</h2>
<p>cpack can generate native binary package for ubuntu and fedora, even MacOS and Windows. Windows NSIS packaging is one package generator for cpack, but it is yet tested. Installation by conda for windows would be a better choice for C++ and Python API users.</p>
<p>Inside the build folder, run <code>make package</code> to generate *.deb or *.rpm.</p>
<p><code>cpack</code>'s configuration (package meta info collection) is located at the bottom of the project toplevel CMakeLists.txt. For each target to install, call the corresponding cmake command <code>install(target ...)</code>.</p>
<h2>packaged files organization</h2>
<p>The generated packages is a all-in-one package include all (lib, bin, python module, headers).</p>
<p>For example, unzip the deb package file, all installed files are organized in subfolders 'bin/', 'lib/', 'include/'</p><ul>
<li>Binaries, executables</li>
<li>Headers, by PUBLIC_HEADER DESTINATION include/Geom</li>
<li>Library, shared libraries like <code>libpppGeom.so</code></li>
<li>Python interface module</li>
</ul>
<p>If system-wide python3 (installed from official repository) is used, which can be confirmed by <code>which python3</code>, this deb/rpm will have the correct python interface module installed.</p>
<p>Note: this fold structure does not work on windows</p>
<p>Headers are not a compiling target, but can be installed eather as files or attached to some compiling target as PUBLIC_HEADER properties. <a href="https://gitlab.kitware.com/cmake/community/wikis/doc/cpack/Component-Install-With-CPack">https://gitlab.kitware.com/cmake/community/wikis/doc/cpack/Component-Install-With-CPack</a> ```cmake</p>
<p>set_target_properties(MyGeom PROPERTIES PUBLIC_HEADER "${GEOM_HEADERS}") # must use quote, otherwise only the first one</p>
<p>install(TARGETS MyGeom RUNTIME DESTINATION bin LIBRARY DESTINATION lib PUBLIC_HEADER DESTINATION include/ppp/Geom COMPONENT libraries ) </p><h1>can be renamed <code>RENAME</code> <code>PERMISSIONS</code></h1>
<p>``` </p><h3>test data</h3>
<p>it is not decided where to install the test data, therefore, unit test can only run in build folder.</p>
<p>test data, test files,</p>
<p>Unit test can be turned off by CMake option <code>-DPPP_USE_TEST=OFF</code></p>
<h2>Python interface module</h2>
<h3>python site-package detection</h3>
<p><code>python3 -c "import sys; print(sys.path)"</code></p>
<p>CMake can install all python stuff like utility scripts and extension module<code>ppp.so/ppp.pyd</code>,</p>
<div class="fragment"><div class="line">execute_process(</div>
<div class="line">    COMMAND &quot;${PYTHON_EXECUTABLE}&quot; -c &quot;if True:</div>
<div class="line">      from distutils import sysconfig as sc</div>
<div class="line">      print(sc.get_python_lib(prefix=&#39;&#39;, plat_specific=True))&quot;</div>
<div class="line">    OUTPUT_VARIABLE PYTHON_SITE</div>
<div class="line">    OUTPUT_STRIP_TRAILING_WHITESPACE)</div>
</div><!-- fragment --><p><code>CPack</code> should generate an all-in-one package (deb/rpm) including this python module. This python module installation route needs more testing for different platform.</p>
<p><code>conda</code> is another choice to support more platforms, by <code>make install</code> ppp.so should be installed to conda python' site, while it is not clear on Windows conda.</p>
<h3>CMake's FindPython has Python_SITELIB, Python_SITEARCH</h3>
<p><code>Python_SITELIB</code> is Third-party platform independent installation directory.</p>
<p>Information returned by <code>distutils.sysconfig.get_python_lib(plat_specific=False,standard_lib=False)</code>.</p>
<div class="fragment"><div class="line">Python_SITEARCH</div>
</div><!-- fragment --><p><code>Python_SITELIB</code> is Third-party platform dependent installation directory.</p>
<p>Information returned by <code>distutils.sysconfig.get_python_lib(plat_specific=True,standard_lib=False)</code>.</p>
<h3>Generate python interface module <code>ppp</code></h3>
<p>The python interface module <code>ppp</code> gives API similar with C++, e.g. class <code>PipelineController</code>, via pybind11 wrapping C++ API. It is a not a pure Python module, but C-extension module must be compiled with a specific python version. It means different installer is needed for python 3.6 and python3.7, even if they link to the same c++ shared libraries (libpppGeom.so).</p>
<p>Although cmake has generate python extension "ppp.*.so" on Linux, it targets only one python version detected by cmake. It should be possible to add cmake option to choose python versions, if multiple versions are installed. To specify the python version during cmake configuration.</p>
<p><code>-DPython_EXECUTABLE=full_path_to_python</code></p>
<p>Extra python interface module can be generated by <code>setup.py</code> for another version of Python, after cmake has successfully compled the all C++ targets such as <code>pppGeom</code> shared library.</p>
<p>It is driven by <code>full_path_to_python setup.py bdist_wheel</code> (implemented yet tested).</p>
<p>Currently, there are 2 hardcoded paths in &lt;../python/setup.py&gt; It is assumed, the binary building dir is the <code>build</code> folder in the repository source dir, (see how the variable <code>ppp_lib_dir</code> assigned in setup.py) just as the compiling instruction shown in &lt;CompileOnLinux.md&gt; If a different building dir is used, manually change that variable. Another assumption is <code>occt_include_dir = "/usr/include/opencascade"</code>, change it if necessary.</p>
<h3>if ppp module is not built, <code>geomPipeline.py</code> still works</h3>
<p>when <code>ppp</code> module is not built/installed, <code>geomPipeline.py</code> will start an external process to run the command <code>geomPipeline your_config.json</code>.</p>
<p><code>geomPipeline.py</code> is pure python script, so <code>geomPipeline your_config.json</code> works for any version of CPython; the drawback is that c++ class's python wrapping is not available.</p>
<h2>Release</h2>
<p>It is expected some binary packages will be generated by CI system on the hosting web. Tutorial for manuall upload binary as release: <a href="https://docs.github.com/en/free-pro-team@latest/github/administering-a-repository/managing-releases-in-a-repository">https://docs.github.com/en/free-pro-team@latest/github/administering-a-repository/managing-releases-in-a-repository</a></p>
<h3>Procedure to make a tagged release</h3>
<p>Github workflow CI should generate new binary packages on each git push, that is dev build with version <code>0.3-dev</code></p>
<p><code>git tag v0.3.0</code> or branch if necessary in the stable release stage. <code>cd build &amp;&amp; cmake -DPPP_VERSION_NAME="0.3.0" -DCMAKE_BUILD_TYPE=Release .. &amp;&amp; make -j4 &amp;&amp; make package</code> run the unit test, then manually upload the packages to github Release.</p>
<p>Docker will be used to generate binary package for more platforms</p>
<p>if version increases, edit</p><ul>
<li><code>PROJECT_VERSION: "0.3-dev"</code> in github workflow CI yml files</li>
<li>PACKAGE_VERSION in project CMakeLists.txt</li>
<li>download link in Readme.md</li>
</ul>
<h3>Generate native packages by CPack in github workflows</h3>
<p>It is important to have a meaningful and precise package file name, which is fixed in the project's CMakeLists.txt, The package file has the name pattern: <code>parallel-preprocessor-&lt;this_software_version&gt;-dev_&lt;OS name&gt;-&lt;OS version&gt;.&lt;package_suffix&gt;</code>. so later the generated package file can be located and uploaded to release endpoints by CI workflow.</p>
<p>If your OS is not supported, you need to compile it by yourself, there is documentation for installation dependency and build for all major platforms.</p>
<p>update source zip : <a href="https://github.com/qingfengxia/parallel-preprocessor/archive/dev.zip">https://github.com/qingfengxia/parallel-preprocessor/archive/dev.zip</a></p>
<h3>Upload daily-build packages to Github Release</h3>
<p>Official actions <code>actions/upload-release-asset@v1</code> does not work for me, so I use "svenstaro/upload-release-action@v2" First of all, I create release tag, then upload binary package manually (creating file endpoint url by this uploading), to reserve a asset url, then run this action to update the package on each push.</p>
<div class="fragment"><div class="line"># those release asset filename (is created manually before running this action)</div>
<div class="line">- name: Upload binary package to release</div>
<div class="line">  uses: svenstaro/upload-release-action@v2</div>
<div class="line">  with:</div>
<div class="line">    repo_token: ${{ secrets.GITHUB_TOKEN }}</div>
<div class="line">    file: ${{ github.workspace }}/build/${{ env.PROJECT_NAME }}-${{ env.PROJECT_VERSION }}_${{ matrix.os }}.deb</div>
<div class="line">    asset_name: ${{ env.PROJECT_NAME }}-${{ env.PROJECT_VERSION }}_${{ matrix.os }}.deb</div>
<div class="line">    tag: dev</div>
<div class="line">    overwrite: true</div>
<div class="line">    prerelease: true</div>
<div class="line">  if: always()</div>
</div><!-- fragment --><h3>Package upload privilege</h3>
<p>Error: Resource not accessible by integration</p>
<p><a href="https://github.com/ukaea/parallel-preprocessor/issues/7">https://github.com/ukaea/parallel-preprocessor/issues/7</a></p>
<p>Only users in the admin group may have the write access to the repo ( e.g. upload packages to release points). Users sent PR will fail, leading to CI check failure.</p>
<p>fix issue#7 by disable uploading package except main branch &lsquo;if: github.ref == 'refs/heads/main&rsquo; # only upload package on main branch, not PR`</p>
<p>Meanwhile developer working with a forked repo should have the write access to the release endpoint in the fork repo.</p>
<h3>Binary conda package (under-testing) for all platforms</h3>
<p>Conda package building also relies on <code>install(target ...)</code> cmake command.</p>
<p>Compiling parallel-preprocessor on windows with dependencies installed by conda-forge, has been confirmed working. Upload to conda-forge is yet configured.</p>
<p>The conda recipe is based on cmake build system. This will install all components (c++ headers, shared-libraries, python interface) to conda's installation directory.</p>
<h3>Container like docker image</h3>
<p>Compile and build in docker has been tested, Dockerfile for fedora, centos, ubuntu LTS are available in the sourse repository.</p>
<h3>Deploy on HPC</h3>
<p>Centos7 has been tested to compile. Deployment on HPC without admin privilege is under-investigation. UKAEA HPC has centos 7.x OS. Singularity image can be a choice for user installation, to maximize the multi-threading or MPI performance. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
