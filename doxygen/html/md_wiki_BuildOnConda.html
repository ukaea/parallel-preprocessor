<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>parallel-preprocessor: Build for Anaconda</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">parallel-preprocessor
   &#160;<span id="projectnumber">0.3.0.f176d79</span>
   </div>
   <div id="projectbrief">MPI distributive and multithreading massively parallel geometry processor     for large scale CAE and machine learning, by Qingfeng Xia, UKAEA, 2019</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_wiki_BuildOnConda.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Build for Anaconda </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Conda package can be generated to support more Linux platforms, and Windows. Conda package build has been tested successfully on local host. <br  />
 In the future, parallel-preprocessor will be available on conda-forge channel for <code>conda install -c condaforge parallel-preprocessor</code> This conda package for parallel-preprocessor has both c++ binary and python wrapper installed, just like build deb package from source by cmake.</p>
<div class="fragment"><div class="line">conda config --add channels conda-forge</div>
<div class="line">conda config --set channel_priority strict</div>
<div class="line">conda install occt</div>
<div class="line">conda install parallel-preprocessor</div>
</div><!-- fragment --><h2>conda recipe: meta.yaml and build scripts</h2>
<p>The meta.yaml and build scripts have been provided in the <code>recipe</code> folder of this repository.</p>
<p>The package config file <code>meta.yaml</code> can be generated by a command, or just adapted from an existing recipe online, e.g. <a href="https://github.com/conda/conda-recipes/tree/master/libtiff">https://github.com/conda/conda-recipes/tree/master/libtiff</a> Also note that the compilers used by conda-build can be specified using a <code>conda_build_config.yaml</code>.</p>
<p>The build scripts <code>build.sh</code> (for Unix-like OS) and <code>bld.bat</code> (windows batch file) have the install instruction (cmake is called just as compiling from source code.), install to a tmp prefix, then compressed into a zipped file, i.e. conda package. <br  />
</p>
<h2>build conda package from local machine</h2>
<p><code>parallel-preprocessor</code> depends on OpenCASCADE conda package, whose conda packaging configuration can be found at <code><a href="https://github.com/conda-forge/occt-feedstock/">https://github.com/conda-forge/occt-feedstock/</a></code>. To build conda package from local machine, user should install all the necessary dependency, such as OpenCASCADE 7.x, TBB, if conda build failed to download the dependencies specified in <code>meta.yaml</code>.</p>
<p>To build conda package, first of all, install anaconda python3 and install necessary packages like <code>conda-build</code>, and run the command in the <code>recipe</code> folder of this repository: <code>conda build meta.ymal</code></p>
<p>The conda build task is conducted a separate virtual environment automatically, so is the test(run) process. <br  />
 <code>D:\Software\anaconda3\envs\cf\conda-bld\ppp_1597347412425</code> On windows, cmake isntalled to the <code>base</code> conda environment can still detect <code>occt</code> package installed in the conda-build tmp conda environment.</p>
<p>NOTE: conda will not auto clean those tmp virtual env, user must manually remove the build virtual env.</p>
<p>anaconda upload /opt/anaconda3/conda-bld/linux-64/parallel-preprocessor-0.3-oct_2020.tar.bz2</p>
<p>To have conda build upload to anaconda.org automatically, use</p>
<p><code>conda config --set anaconda_upload yes</code></p>
<h2>install built local conda package</h2>
<p>Where is the generated conda package? <br  />
 If testing script passed, the generated conda package, a compressed file, should be copied to the current working directory. <br  />
 If test failed, there may be error message: </p><blockquote class="doxtable">
<p>Tests failed for ppp-0.3-hdef9aff_2003.tar.bz2 - moving package to D:\Software\anaconda3\envs\cf\conda-bld\broken </p>
</blockquote>
<p>After conda build, the built package can be installed: <code>conda install --use-local ppp</code> or equally <code>conda install -c local ppp</code> to install the built pkg. <code>conda install --use-local ppp --dry-run</code> to test if built package can be found and installed. <code>conda verify</code> may also verify the package without installation.</p>
<p>It is expected binary conda package for parallel-preprocessor will be hosted on github or conda-forge. After downloaded from github Release, the compressed package file can be installed by the command</p>
<div class="fragment"><div class="line">conda install package-path/package-filename.tar.bz2</div>
</div><!-- fragment --><h2>Conda build variants</h2>
<p><a href="https://docs.conda.io/projects/conda-build/en/latest/resources/variants.html">https://docs.conda.io/projects/conda-build/en/latest/resources/variants.html</a></p>
<p>selector document</p>
<p>Here is an example to skip some variants in meta.yaml file.</p>
<div class="fragment"><div class="line">build:</div>
<div class="line">    skip: true  # [win or osx]</div>
</div><!-- fragment --><h2>build for multiple python versions</h2>
<p>Since python the optional interface module for parallel preprocessor is C-extension, so separate binary packages are needed for conda python 3.6, 3.7 and 3.8. Depends on platforms, conda python 3.8 may be minimum version to support C++17.</p>
<p>conda build support build for multiple version, by specify <code>--py</code> option multiple times. <code>conda build --py 3.6 --py 3.7 --py 3.8 recipe</code> if this does not work, try &lsquo;conda build recipe --variants "{'python&amp;rsquo;: ['2.7', '3.6'], 'vc': ['9', '14']}"`</p>
<p>After all, variant control is done by the yaml file<code>conda_build_config.yaml</code>. If this file does not exists same directory as<code>meta.yaml</code>, <code>conda build</code> may generate one. real also <a href="https://medium.com/@MaheshSawaiker/conda-multi-variant-builds-8edc35c215d7">Conda multi variant builds</a></p>
<h2>conda-forge build environment</h2>
<p>Build environments in conda-forge CI (miniconda azure pipeline, ) is quite different from conda build on local machine. After trials and referencing to <a href="https://github.com/FreeCAD/FreeCAD/blob/master/conda/,">https://github.com/FreeCAD/FreeCAD/blob/master/conda/,</a> finally conda build is working.</p>
<p>conda windows python 3.8 using "VS 2017 update 9", although it is called <code>vs2015_runtime</code> indicating binary compatible, it may be using vs2017 (14.1) compiler.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><a href="https://docs.anaconda.com/anaconda/packages/py3.8_win-64/None">vs2015_runtime</a> </th><th class="markdownTableHeadNone">14.16.27012 </th><th class="markdownTableHeadNone">MSVC runtimes associated with cl.exe version 19.16.27032.1 (VS 2017 update 9) / None  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><a href="https://github.com/conda/conda/wiki/VC-features">vc</a> </td><td class="markdownTableBodyNone">14.1 </td><td class="markdownTableBodyNone"><a class="el" href="classA.html" title="a dummy class to test property container">A</a> meta-package to impose mutual exclusivity among software built with different VS versions / Modified BSD License (3-clause)  </td></tr>
</table>
<p>The default conda macos conda-build using MacOS SDK 10.09, XCode 11.6, but MacOS 10.13 is needed for C++17 support. Therefore, the MacOS deploy target has been limited to "10.15", in &lt;../recipe/conda_build_config.yaml&gt;</p>
<blockquote class="doxtable">
<p>/src/PropertyContainer/PropertyContainerTest.cpp:46:22: error: 'any_cast&lt;std::__1::shared_ptr&lt;A&gt; &gt;' is unavailable: introduced in macOS 10.13 </p>
</blockquote>
<p>auto data = std::any_cast&lt;std::shared_ptr&lt;myType&gt;&gt;(a);</p>
<p>libGL is needed to build OCCT and parallel-preprocessor.</p>
<h2>Upload to conda forge (yet done)</h2>
<p>Here is guide from conda-forge website: </p><blockquote class="doxtable">
<p>If your package is not on conda-forge yet you can follow their contribution documentation here: <a href="https://conda-forge.org/#add_recipe">https://conda-forge.org/#add_recipe</a> </p>
</blockquote>
<p>The process: <a href="https://conda-forge.org/docs/maintainer/adding_pkgs.html">https://conda-forge.org/docs/maintainer/adding_pkgs.html</a></p>
<ol type="1">
<li>fork conda-forge example repo</li>
</ol>
<p><a href="https://github.com/qingfengxia/staged-recipes">https://github.com/qingfengxia/staged-recipes</a></p>
<ol type="1">
<li>push it as a new repo from the branch "parallel-preprocessor"</li>
</ol>
<p><a href="https://github.com/conda-forge/staged-recipes/pull/12901#issuecomment-709514486">https://github.com/conda-forge/staged-recipes/pull/12901#issuecomment-709514486</a></p>
<p>get attention from gitter <a href="https://gitter.im/conda-forge/conda-forge.github.io">https://gitter.im/conda-forge/conda-forge.github.io</a></p>
<ol type="1">
<li>later the maintainer (pusher) will have the write control on that repo.</li>
</ol>
<h2>Conda recipe feedback</h2>
<blockquote class="doxtable">
<h3>**<a href="https://github.com/chrisburr">chrisburr</a>** Contributor</h3>
<p></p>
<p>I guess <code>occt</code> is being used as a shared library? If so it should use pin_compatible to make sure an ABI compatible version is used.</p>
<blockquote class="doxtable">
<p>Author:</p>
<p>yes, occt is build by one FreeCAD developer. it should be something like numpy version, must be matched. shall I use occt == 7.4? I propabaly needs to follow the update of occt version, somehow, I know occt 7.4 is the only version on conda-forge </p>
</blockquote>
<p>tbb also has the API compatibility issue </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
