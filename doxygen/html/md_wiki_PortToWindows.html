<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>parallel-preprocessor: Port to Windows</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">parallel-preprocessor
   &#160;<span id="projectnumber">0.3.0.f176d79</span>
   </div>
   <div id="projectbrief">MPI distributive and multithreading massively parallel geometry processor     for large scale CAE and machine learning, by Qingfeng Xia, UKAEA, 2019</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_wiki_PortToWindows.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Port to Windows </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document records some notes on porting parallel-preprocessor to Windows 10</p>
<h2>Platform C++ runtime difference</h2>
<p>C++ demangle, needs boost if using msvc compiler</p>
<p>Windows has no complete "signal.h" support. </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">#include &lt;csignal&gt;</div>
<div class="line">sigemptyset()   // no such on windows? mingw32?</div>
</div><!-- fragment --><h2>mingw32-w64 v8.1 compiler</h2>
<p>mingw has problem with filesystem, and there is no easy solution. and As the official OpenCASCADE has been built with VC141 (VS2017) The binary compatibility of mingw and visual C++ is doubtable in production scenario. <br  />
</p>
<p><a href="https://github.com/mxe/mxe/issues/2220">https://github.com/mxe/mxe/issues/2220</a> the gcc 9 patch seems to fix this issue <a href="https://sourceforge.net/p/mingw-w64/bugs/737/">https://sourceforge.net/p/mingw-w64/bugs/737/</a></p>
<p>there is the error message</p>
<blockquote class="doxtable">
<p>D:/Software/mingw64/lib/gcc/x86_64-w64-mingw32/8.1.0/include/c++/bits/fs_path.h:237:47: error: no match for 'operator!=' (operand types are 'std::filesystem::__cxx11::path' and 'std::filesystem::__cxx11::path') </p>
</blockquote>
<p>|| (__p.has_root_name() &amp;&amp; __p.root_name() != root_name()))</p>
<p>Stop trying on mingw.</p>
<h2>Windows visual c++ compiler different from g++</h2>
<ol type="1">
<li>Visual C++ does not define <code>__cplusplus</code> properly to detect C++ std supported. Visual C++ support C++9x or just C++14, skipped c++11 <code>#ifndef _MSC_VER&amp;&amp; __cplusplus &lt; 201402L</code></li>
<li>NMake does not support parallel compiling, but msbuild has parallel support</li>
<li>To let visual C++ to support <code>not, and, or</code> keywords, <code>#include &lt;iso646.h&gt;</code></li>
<li>Clang' command line options is comptable with C++, but visual studio is distinct.</li>
<li>VC (or even MingG32?) link to OCCT *.lib (import lib), and to run needs *.dll files</li>
<li>some macro is needed to assist symbol import and export from dll, <code>DLLimport</code></li>
</ol>
<h3>conda install boost can not link to boost lib</h3>
<p>&ndash; Found the following Boost libraries: &ndash; system 'libboost_filesystem-vc140-mt-gd-x64-1_67.lib'</p>
<p>LINK : fatal error LNK1104: cannot open file 'libboost_filesystem-vc141-mt-gd-x64-1_67.lib'</p>
<h2>Visual C++ compiling output</h2>
<p>There are static libraries (LIB) and dynamic libraries (DLL) - but note that .LIB files can be either static libraries (containing object files) or import libraries (containing symbols to allow the linker to link to a DLL).</p>
<p>*.exp symbol export file (.exp) for the program, <code>dumpbin /exports</code> *.def symbol definition file, <code>__declspec(dllexport)</code> *.lib could be import library, for linker to link and find symbols *.ilk - this file is for incremental linking *.pdb - Program database (.pdb) files, also called symbol files, map identifiers and statements in your project's source code to corresponding identifiers and instructions in compiled apps. These mapping files link the debugger to your source code, which enables debugging.</p>
<p>Typically DLLs go in a folder named “bin”, and import libraries go in a folder named “lib”</p>
<h2>dllexport for windows DLL</h2>
<p>** header only library does not needs, __declspec(dllexport), only for impl in cpp files**</p>
<p>You can export data, functions, classes, or class member functions from a DLL using the <code>__declspec(dllexport)</code> keyword. <code>__declspec(dllexport)</code> adds the export directive to the object file so you do not need to use a .def file. <br  />
 MingW32 still needs this <code>__declspec(dllexport)</code> for windows.</p>
<p>In short, when building this module, <code>__declspec(dllexport)</code> should be used in header files to export symbols, while to use those symbols(functions/types) in another module, <code>__declspec(dllimport)</code> should be used in the header files. <a class="el" href="classA.html" title="a dummy class to test property container">A</a> more flexible solution: for each cmake SHARED library target. e.g. define</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#if _WIN32</div>
<div class="line">#   ifdef APP_DLL_EXPORT</div>
<div class="line">#       define  AppExport  __declspec(dllexport)</div>
<div class="line">#   else</div>
<div class="line">#       define  AppExport  __declspec(dllimport)</div>
<div class="line">#   endif</div>
<div class="line">#else</div>
<div class="line">#   define  AppExport</div>
<div class="line">#endif</div>
</div><!-- fragment --><p>Use the macro for each class, struct, enum <code>class AppExport Processor</code> Also def the option, for the target, to export symbols</p>
<div class="fragment"><div class="line">if(WIN32)</div>
<div class="line">    target_compile_definitions(MyApp PRIVATE APP_DLL_EXPORT=1)  <span class="comment"># DLL export on windows</span></div>
<div class="line">endif()</div>
</div><!-- fragment --><p>with this definition, cmake can generate pppApp.lib, but it is not in the output lib folder <code>lib</code> , but in another folder in the build directory <code>PPP/pppApp.lib</code> TODO: let cmake collect those *.lib and put into lib output folder.</p>
<p>for header only library, that is not necessary? </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">extern &quot;C&quot;</div>
<div class="line">{ // only need to export C interface if used by C++ source code</div>
<div class="line">#include &quot;third-party/mm_io.h&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p><code>set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)</code></p>
<h3>for free functions inside namespace</h3>
<p>free function means not member functions of any class/struct.</p>
<p>They do need <code>__declspec(dllexport)</code> , but if no other module use it, it is internal function, there is no need to export the function. However, in the case of function template, the keyword <code>__declspec(dllexport)</code> needs to be present explicitly for the symbols to be present on the dynamic library. </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">template AppExport void HelpingRegistration&lt;double&gt;( double );</div>
<div class="line">AppExport void my_function(void);</div>
</div><!-- fragment --><p>error C2491: definition of dllimport static data member not allowed </p><blockquote class="doxtable">
<p>check cmake for that module, e.g. copy-and-paste, but forget to change target name to the new target name </p>
</blockquote>
<div class="fragment"><div class="line">if(WIN32)</div>
<div class="line">    target_compile_definitions(MyApp PRIVATE APP_DLL_EXPORT=1)  # DLL export on windows</div>
<div class="line">endif()</div>
</div><!-- fragment --><h3>for free variable export</h3>
<p>static variable may cause some trouble.</p>
<h3>for template class</h3>
<p>There is no need to specify <code>__declspec(dllexport)</code>, since template class impl usually in header file.</p>
<blockquote class="doxtable">
<p><a class="el" href="classA.html" title="a dummy class to test property container">A</a> template will only be compiled with specified template parameter. Thus there will be nothing in the dll to link against. </p>
</blockquote>
<p>In order to use a template you always need to include both: declaration and definition. You cannot put the definitions in a .cpp file like ordinary classes/functions. <a href="http://www.cplusplus.com/forum/windows/199689/">http://www.cplusplus.com/forum/windows/199689/</a></p>
<p>If moving impl into cpp file, got missing symbol error, when used by another target/module.</p>
<p><a href="https://stackoverflow.com/questions/17519879/visual-studio-dll-export-issue-for-class-and-function-template-instantiations">https://stackoverflow.com/questions/17519879/visual-studio-dll-export-issue-for-class-and-function-template-instantiations</a></p>
<p>I believe you need to export the specializations. Have you tried this in your .cpp file: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">template class EXPORT TemplatedStaticLib&lt;double&gt;;</div>
<div class="line">template class EXPORT TemplatedStaticLib&lt;std::string&gt;;</div>
<div class="line"> </div>
<div class="line">//and pretty much the same in your header:</div>
<div class="line"> </div>
<div class="line">template class EXPORT TemplateStaticLib&lt;double&gt;;</div>
<div class="line">template class EXPORT TemplateStaticLib&lt;std::string&gt;;</div>
</div><!-- fragment --><p>warning C4661: 'PPP::SparseMatrix&lt;bool&gt; PPP::SparseMatrix&lt;bool&gt;::readMatrixMarketFile(const std::string &amp;)': no suitable definition provided for explicit template instantiation request</p>
<p>for typedef</p>
<h3>for third-party headers?</h3>
<ol type="1">
<li>use all third-party headers in cpp file, without exposed any symbol to public header files</li>
<li>SparseMatrix is a template class, its implementation should be only in header file, so mm_io.h must be included in <a class="el" href="SparseMatrix_8h_source.html">SparseMatrix.h</a>, In this situation, modified mm_io.h by adding "AppExport" macro</li>
<li>loguru.h's LOG_F() can print real line number, and it is a submodule. Therefore do not modify loguru.h directly, by appending <code>AppExport</code> to each functions in loguru.hpp but including loguru.cpp in each build target (*.dll, *.so), to solve the problem of symbol not defined/exported. <div class="fragment"><div class="line"> {c++}</div>
<div class="line">#if defined(_WIN32)</div>
<div class="line">#include &quot;../third-party/loguru/loguru.cpp&quot;</div>
<div class="line">#endif</div>
</div><!-- fragment --></li>
</ol>
<h2>suppress msvc warning on symbol exporting</h2>
<p><a href="https://stackoverflow.com/questions/24511376/how-to-dllexport-a-class-derived-from-stdruntime-error">https://stackoverflow.com/questions/24511376/how-to-dllexport-a-class-derived-from-stdruntime-error</a> How to dllexport a class derived from std::runtime_error?</p>
<p><code>class __declspec(dllexport) BaseException : public std::runtime_error</code> However, this gives me </p><blockquote class="doxtable">
<p>warning C4275: non – DLL-interface class 'std::runtime_error' used as base for DLL-interface class 'BaseException'. </p>
</blockquote>
<p>warning C4273: 'Geom::GeometryFixer::init': inconsistent dll linkage warning C4275: non dll-interface class 'std::exception' used as base for dll-interface class '<a class="el" href="classPPP_1_1ProcessorError.html">PPP::ProcessorError</a>'</p>
<p>Solutions: Export it. Ignore it. In-line it.</p>
<p><b>warning C4275: non dll-interface class used as base for dll-interface class</b></p>
<div class="fragment"><div class="line">if(MSVC)</div>
<div class="line">     target_compile_options(fmt PRIVATE /wd4251  /wd4275)</div>
<div class="line"> endif()</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
